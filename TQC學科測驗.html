<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TQC 測驗系統</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #007bff;
            margin-bottom: 20px;
        }

        .card {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .mode-select label {
            display: block;
            margin-bottom: 10px;
        }

        .question-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            margin: 10px 0;
        }

        #questionPage {
            display: none;
        }

        #options label {
            display: block;
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1 1 30%;
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }

        button:hover {
            opacity: 0.9;
        }

        #progressBar {
            width: 100%;
            height: 15px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        #progressBarFill {
            height: 100%;
            width: 0%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }

        @media screen and (max-width: 600px) {
            .button-group {
                flex-direction: column;
            }

            button {
                flex: 1 1 100%;
            }

            .question-image {
                max-height: 200px;
            }
        }

    </style>
</head>

<body>
    <div class="container">
        <h1>TQC 學科測驗</h1>

        <div id="startPage" class="card">
            <div class="mode-select">
                <label><input type="radio" name="mode" id="instantMode" value="instant" /> 練習模式（即時對答案）</label>
                <label><input type="radio" name="mode" id="examMode" value="exam" /> 考試模式（不即時對答案）</label>
                <label for="quizSelect">選擇題庫:</label>
                <select id="quizSelect">
                    <option value="quiz1">軟體開發知識</option>
                    <option value="quiz2">HTML</option>
                </select>
            </div>
            <button id="startTest">開始測驗</button>
        </div>

        <div id="questionPage" class="card">
            <div id="timer">剩餘時間：40:00</div>
            <div id="score" style="display:none;">你的得分：0 / 100</div>
            <div id="questionNumber"></div>
            <div id="progressBar">
                <div id="progressBarFill"></div>
            </div>
            <div id="question"></div>
            <div id="options"></div>
            <div class="button-group">
                <button id="prev">上一題</button>
                <button id="submit">下一題</button>
                <button id="finish">交卷</button>
            </div>
        </div>

        <div id="result" class="card"></div>
        <div id="answers" class="card"></div>
    </div>

    <script>
        let quizData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        const totalQuestions = 50;
        const passingScore = 35;
        let userAnswers = [];
        let checkedQuestions = Array(totalQuestions).fill(false);
        let timeLeft = 2400;
        let timerInterval;
        let isInstantMode = false;

        const timerEl = document.getElementById("timer");
        const scoreEl = document.getElementById("score");
        const progressBarFill = document.getElementById("progressBarFill");

        const quizFiles = {
            quiz1: "questions.json",
            quiz2: "questions2.json"
        };

        function startTimer() {
            timerInterval = setInterval(() => {
                if (timeLeft <= 0) return endQuiz();
                let min = Math.floor(timeLeft / 60);
                let sec = (timeLeft % 60).toString().padStart(2, '0');
                timerEl.innerText = `剩餘時間：${min}:${sec}`;
                timeLeft--;
            }, 1000);
        }

        function loadQuiz() {
            const selectedQuiz = document.getElementById("quizSelect").value;
            fetch(quizFiles[selectedQuiz])
                .then(res => res.json())
                .then(data => {
                    quizData = data.sort(() => 0.5 - Math.random()).slice(0, totalQuestions);
                    loadQuestion();
                })
                .catch(err => {
                    alert("題庫載入錯誤，請確認 JSON 檔案存在並正確。");
                    console.error(err);
                });
        }

        function loadQuestion() {
            if (currentQuestionIndex >= quizData.length) return endQuiz();
            const q = quizData[currentQuestionIndex];
            document.getElementById("questionNumber").innerText = `第 ${currentQuestionIndex + 1} / ${totalQuestions} 題`;

            const questionEl = document.getElementById("question");
            const optionsEl = document.getElementById("options");
            questionEl.innerHTML = "";
            optionsEl.innerHTML = "";

            const images = q.images || [];
            images.forEach(src => {
                const img = document.createElement("img");
                img.src = src;
                img.alt = "question image";
                img.style.maxWidth = "100%";
                img.style.margin = "10px 0";
                questionEl.appendChild(img);
            });

            const questionText = document.createElement("div");
            questionText.innerHTML = q.question;
            questionEl.appendChild(questionText);

            q.options.forEach((opt, i) => {
                const label = document.createElement("label");
                const input = document.createElement("input");
                input.type = q.answer.length > 1 ? "checkbox" : "radio";
                input.name = "answer";
                input.value = i + 1;
                if (userAnswers[currentQuestionIndex]?.includes(i + 1)) input.checked = true;
                input.addEventListener("change", updateScore);
                label.appendChild(input);
                label.append(` ${opt}`);
                optionsEl.appendChild(label);
            });

            document.getElementById("prev").disabled = currentQuestionIndex === 0;
            updateProgressBar();
        }

        function updateScore() {
            const selected = Array.from(document.querySelectorAll("input[name='answer']:checked"))
                .map(opt => parseInt(opt.value));
            userAnswers[currentQuestionIndex] = selected;

            const correct = quizData[currentQuestionIndex].answer;
            const isCorrect = JSON.stringify(selected.sort()) === JSON.stringify(correct.sort());

            if (isInstantMode) {
                if (isCorrect && !checkedQuestions[currentQuestionIndex]) {
                    score += 2;
                    checkedQuestions[currentQuestionIndex] = true;
                }
                if (!isCorrect && checkedQuestions[currentQuestionIndex]) {
                    score -= 2;
                    checkedQuestions[currentQuestionIndex] = false;
                }
                scoreEl.innerText = `你的得分：${score} / ${totalQuestions * 2}`;
                scoreEl.style.display = "block";
            }
        }

        function updateProgressBar() {
            const percent = ((currentQuestionIndex + 1) / totalQuestions) * 100;
            progressBarFill.style.width = `${percent}%`;
        }

        function endQuiz() {
            clearInterval(timerInterval);

            if (!isInstantMode) {
                score = 0;
                quizData.forEach((q, i) => {
                    const userAns = userAnswers[i] || [];
                    const correct = q.answer;
                    const isCorrect = JSON.stringify(userAns.sort()) === JSON.stringify(correct.sort());
                    if (isCorrect) score += 2;
                });
                scoreEl.innerText = `你的得分：${score} / ${totalQuestions * 2}`;
                scoreEl.style.display = "block";
            }

            const passed = score >= passingScore * 2;
            const resultEl = document.getElementById("result");
            resultEl.innerText = passed ? "🎉 恭喜你通過測驗！" : "😢 很可惜，未達到通過分數。";
            resultEl.style.color = passed ? "green" : "red";
            resultEl.style.fontSize = "24px";
            resultEl.style.animation = "flash 1s ease-in-out 3";

            showAnswers();

            const restartBtn = document.createElement("button");
            restartBtn.textContent = "重新測驗";
            restartBtn.style.backgroundColor = "#007bff";
            restartBtn.style.color = "white";
            restartBtn.onclick = () => location.reload();
            resultEl.appendChild(document.createElement("br"));
            resultEl.appendChild(restartBtn);
        }

        function showAnswers() {
            const container = document.getElementById("answers");
            container.innerHTML = "<h2>對答案</h2>";
            quizData.forEach((q, i) => {
                const userAns = userAnswers[i] || [];
                const correctAns = q.answer;
                const isCorrect = JSON.stringify(userAns.sort()) === JSON.stringify(correctAns.sort());

                const div = document.createElement("div");
                div.style.borderLeft = `5px solid ${isCorrect ? "green" : "red"}`;
                div.style.backgroundColor = "#fff";
                div.style.margin = "10px 0";
                div.style.padding = "10px";

                const questionHTML = document.createElement("div");
                questionHTML.innerHTML = `<strong>第 ${i + 1} 題：</strong> ${q.question}`;
                div.appendChild(questionHTML);

                (q.images || []).forEach(src => {
                    const img = document.createElement("img");
                    img.src = src;
                    img.style.maxWidth = "100%";
                    img.style.margin = "10px 0";
                    div.appendChild(img);
                });

                const optionsHTML = q.options.map((opt, idx) => {
                    const num = idx + 1;
                    const userSel = userAns.includes(num);
                    const isCorrectOpt = correctAns.includes(num);
                    let color = "#333";
                    if (isCorrectOpt && userSel) color = "green";
                    else if (isCorrectOpt) color = "blue";
                    else if (userSel) color = "red";

                    return `<div style="color:${color}">${num}. ${opt}</div>`;
                }).join("");

                const answerHTML = `
            <div>${optionsHTML}</div>
            <div>✅ 正確答案：<span style="color:green">${correctAns.map(n => `${n}. ${q.options[n - 1]}`).join("，")}</span></div>
            <div>📝 你的答案：<span style="color:${isCorrect ? 'green' : 'red'}">${userAns.length ? userAns.map(n => `${n}. ${q.options[n - 1]}`).join("，") : "未作答"}</span> ${isCorrect ? "✅" : "❌"}</div>
        `;
                div.innerHTML += answerHTML;
                container.appendChild(div);
            });
        }

        document.getElementById("submit").addEventListener("click", () => {
            currentQuestionIndex++;
            if (currentQuestionIndex >= totalQuestions) {
                endQuiz();
            } else {
                loadQuestion();
            }
        });

        document.getElementById("prev").addEventListener("click", () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        });

        document.getElementById("finish").addEventListener("click", endQuiz);

        document.getElementById("startTest").addEventListener("click", () => {
            isInstantMode = document.getElementById("instantMode").checked;
            document.getElementById("startPage").style.display = "none";
            document.getElementById("questionPage").style.display = "block";
            loadQuiz();
            startTimer();
        });

    </script>
</body>

</html>

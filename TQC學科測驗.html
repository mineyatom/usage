<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TQC 測驗系統</title>
    <style>
        /* 全局樣式 */
        body {
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #2c3e50;
            overflow-y: auto;
        }

        .container {
            max-width: 900px;
            margin: auto;
            padding: 20px;
            min-height: 100vh;
        }

        h1 {
            text-align: center;
            color: #4a90e2;
        }

        .card {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* 模式選擇和開始按鈕 */
        .mode-select label {
            display: block;
            margin-bottom: 10px;
        }

        /* 題目選項 */
        #options label {
            display: block;
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
            cursor: pointer;
            /* 自動換行 */
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* 按鈕群組 */
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        button,
        .button-group button {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background-color: #4a90e2;
            color: #fff;
            cursor: pointer;
            transition: all .2s;
        }

        button:hover,
        .button-group button:hover {
            background-color: #357ab7;
            transform: translateY(-2px);
        }

        button:active {
            transform: scale(0.97);
        }

        /* 自訂按鈕顏色 */
        .btn-green {
            background-color: #28a745;
        }

        .btn-green:hover {
            background-color: #218838;
        }

        .btn-blue {
            background-color: #003366;
        }

        .btn-blue:hover {
            background-color: #002244;
        }

        .btn-red {
            background-color: #dc3545;
        }

        .btn-red:hover {
            background-color: #c82333;
        }

        button.btn-yellow {
            background-color: #ffc107;
            color: #000;
        }

        button.btn-yellow:hover {
            background-color: #e0a800;
        }

        /* 進度條 */
        #progressBar {
            height: 15px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        #progressBarFill {
            height: 100%;
            width: 0;
            background: #28a745;
            transition: width .3s;
        }

        @media (max-width:600px) {
            .button-group {
                flex-direction: column;
            }
        }

    </style>
</head>

<body>
    <div class="container">
        <h1>TQC 學科測驗</h1>

        <!-- 開始頁面 -->
        <div id="startPage" class="card">
            <div class="mode-select">
                <label><input type="radio" name="mode" id="instantMode" value="instant" /> 練習模式（即時對答案）</label>
                <label><input type="radio" name="mode" id="examMode" value="exam" /> 考試模式（不即時對答案）</label>
            </div>
            <label>選擇題庫:
                <select id="quizSelect">
                    <option value="quiz1">軟體開發知識2022版</option>
                    <option value="quiz2">軟體開發知識2025版</option>
                    <option value="quiz3">HTML</option>
                </select>
            </label>
            <button id="startTest" class="btn-green">開始測驗</button>
            <button id="showStats" class="btn-blue">查看出題統計</button>
            <button id="clearStats" class="btn-red">清除出題紀錄</button>
        </div>

        <!-- 測驗頁面 -->
        <div id="questionPage" class="card" style="display:none;">
            <div id="timer">剩餘時間：40:00</div>
            <div id="score" style="display:none;"></div>
            <div id="questionNumber"></div>

            <!-- 標記題目 功能 -->
            <label><input type="checkbox" id="markCurrent" /> 標記此題</label>

            <!-- 轉頁與標記按鈕群組 -->
            <div class="button-group">
                <button id="prev">上一題</button>
                <button id="submit">下一題</button>
                <button id="viewMarked" class="btn-yellow">查看標記題目</button>
                <button id="finish">交卷</button>
            </div>

            <!-- 進度條顯示 -->
            <div id="progressBar">
                <div id="progressBarFill"></div>
            </div>

            <!-- 題目內容區 -->
            <div id="question"></div>
            <!-- 選項列表區 -->
            <div id="options"></div>
        </div>

        <!-- 詳細解答與統計結果顯示 -->
        <div id="answers" class="card"></div>
        <div id="statsTableContainer" class="card"></div>
    </div>

    <script>
        // 題庫檔案對應
        const quizFiles = {
            quiz1: "questions.json",
            quiz2: "questions2.json",
            quiz3: "TQCHTML.json"
        };

        // 全域狀態
        let quizData = [],
            currentQuestionIndex = 0,
            score = 0;
        const totalQuestions = 50,
            passingScore = 35;
        let userAnswers = [],
            checkedQuestions = Array(totalQuestions).fill(false),
            userMarks = Array(totalQuestions).fill(false),
            timeLeft = 2400,
            timerInterval, isInstantMode = false;

        // DOM 參考
        const timerEl = document.getElementById('timer'),
            scoreEl = document.getElementById('score'),
            progressBarFill = document.getElementById('progressBarFill');
        const markCheckbox = document.getElementById('markCurrent'),
            viewMarkedBtn = document.getElementById('viewMarked');

        /** 開始倒數計時 */
        function startTimer() {
            timerInterval = setInterval(() => {
                if (timeLeft <= 0) return endQuiz();
                const m = Math.floor(timeLeft / 60);
                const s = String(timeLeft % 60).padStart(2, '0');
                timerEl.innerText = `剩餘時間：${m}:${s}`;
                timeLeft--;
            }, 1000);
        }

        /** 載入題庫 JSON */
        function fetchQuizData(url, callback) {
            fetch(url)
                .then(res => res.json())
                .then(callback)
                .catch(() => alert('資料載入錯誤！'));
        }

        /** 記錄出題與答對次數 */
        function recordQuestionStats(id, isCorrect) {
            const key = 'quiz_stats';
            const stats = JSON.parse(localStorage.getItem(key)) || {};
            if (!stats[id]) stats[id] = {
                count: 0,
                correct: 0
            };
            stats[id].count++;
            if (isCorrect) stats[id].correct++;
            localStorage.setItem(key, JSON.stringify(stats));
        }

        /** 儲存目前答案與標記 */
        function saveCurrentAnswer() {
            userAnswers[currentQuestionIndex] = Array.from(
                document.querySelectorAll("input[name='answer']:checked")
            ).map(e => +e.value);
            userMarks[currentQuestionIndex] = markCheckbox.checked;
        }

        /** 隨機取題並啟動 */
        function loadQuiz() {
            const sel = document.getElementById('quizSelect').value;
            fetchQuizData(quizFiles[sel], data => {
                // 打亂、權重、選題流程
                data.sort(() => 0.5 - Math.random());
                const stats = JSON.parse(localStorage.getItem('quiz_stats')) || {};
                const pool = [];
                data.forEach(q => {
                    const id = q.id || q.question;
                    const cnt = stats[id]?.count || 0;
                    const weight = Math.ceil(10 / (cnt + 1));
                    for (let j = 0; j < weight; j++) pool.push(q);
                });
                const selected = [];
                const used = new Set();
                while (selected.length < totalQuestions && pool.length) {
                    const idx = Math.floor(Math.random() * pool.length);
                    const q = pool.splice(idx, 1)[0];
                    const id = q.id || q.question;
                    if (!used.has(id)) {
                        selected.push(q);
                        used.add(id);
                    }
                }
                while (selected.length < totalQuestions) {
                    selected.push(data[Math.floor(Math.random() * data.length)]);
                }
                quizData = selected;
                currentQuestionIndex = 0;
                loadQuestion();
            });
        }

        /** 顯示單題 */
        function loadQuestion() {
            const qObj = quizData[currentQuestionIndex];
            const qId = qObj.id || qObj.question;
            recordQuestionStats(qId, false);

            document.getElementById('questionNumber').innerText = `第 ${currentQuestionIndex + 1} / ${totalQuestions} 題`;
            markCheckbox.checked = userMarks[currentQuestionIndex];
            document.getElementById('prev').disabled = currentQuestionIndex === 0;

            // 下一題按鈕顯示控制
            const nextBtn = document.getElementById('submit');
            if (currentQuestionIndex === totalQuestions - 1) nextBtn.style.display = 'none';
            else nextBtn.style.display = 'inline-block';

            const qEl = document.getElementById('question');
            const oEl = document.getElementById('options');
            qEl.innerHTML = '';
            oEl.innerHTML = '';

            let raw = qObj.question.replace(/<img.*?>/g, '')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>');
            const txt = document.createElement('div');
            txt.textContent = raw;
            qEl.appendChild(txt);
            const imgMatch = qObj.question.match(/<img src=['"](.*?)['"]/);
            if (imgMatch) {
                const img = document.createElement('img');
                img.src = imgMatch[1];
                img.className = 'question-image';
                qEl.appendChild(img);
            }

            qObj.options.forEach((opt, idx) => {
                const label = document.createElement('label');
                const inp = document.createElement('input');
                inp.type = qObj.answer.length > 1 ? 'checkbox' : 'radio';
                inp.name = 'answer';
                inp.value = idx + 1;
                inp.checked = (userAnswers[currentQuestionIndex] || []).includes(idx + 1);
                inp.addEventListener('change', updateScore);
                label.appendChild(inp);
                label.append(` ${opt}`);
                oEl.appendChild(label);
            });

            progressBarFill.style.width = `${(currentQuestionIndex + 1) / totalQuestions * 100}%`;
        }

        /** 更新分數（即時模式） */
        function updateScore() {
            const sel = Array.from(document.querySelectorAll("input[name='answer']:checked")).map(e => +e.value);
            userAnswers[currentQuestionIndex] = sel;
            const correctAns = quizData[currentQuestionIndex].answer;
            const isCor = JSON.stringify(sel.sort()) === JSON.stringify(correctAns.sort());
            if (isInstantMode) {
                if (isCor && !checkedQuestions[currentQuestionIndex]) {
                    score += 2;
                    checkedQuestions[currentQuestionIndex] = true;
                }
                if (!isCor && checkedQuestions[currentQuestionIndex]) {
                    score -= 2;
                    checkedQuestions[currentQuestionIndex] = false;
                }
                scoreEl.innerText = `你的得分：${score} / ${totalQuestions * 2}`;
                scoreEl.style.display = 'block';
            }
            recordQuestionStats(quizData[currentQuestionIndex].id || quizData[currentQuestionIndex].question, isCor);
        }

        /** 結束測驗並顯示結果 */
        function endQuiz() {
            clearInterval(timerInterval);
            if (!isInstantMode) {
                score = 0;
                quizData.forEach((qObj, idx) => {
                    const ua = userAnswers[idx] || [];
                    const isCor = JSON.stringify(ua.sort()) === JSON.stringify(qObj.answer.sort());
                    if (isCor) score += 2;
                    recordQuestionStats(qObj.id || qObj.question, isCor);
                });
            }
            const passed = score >= passingScore * 2;
            scoreEl.innerHTML = `
                <div style="font-size:20px; margin-bottom:10px;">你的得分：${score} / ${totalQuestions * 2}</div>
                <div style="font-size:24px; color:${passed ? 'green' : 'red'};">${passed ? '🎉 恭喜通過！' : '😢 未達標'}</div>
            `;
            const btn = document.createElement('button');
            btn.textContent = '重新測驗';
            btn.className = 'btn-blue';
            btn.onclick = () => location.reload();
            scoreEl.appendChild(btn);
            scoreEl.style.display = 'block';
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // 事件綁定
        document.getElementById('startTest').addEventListener('click', () => {
            const modeSel = document.querySelector("input[name='mode']:checked");
            if (!modeSel) return alert('請選擇測驗模式');
            isInstantMode = document.getElementById('instantMode').checked;
            document.getElementById('startPage').style.display = 'none';
            document.getElementById('questionPage').style.display = 'block';
            document.body.style.backgroundColor = isInstantMode ? '#ffe6ec' : '#e6ecf2';
            loadQuiz();
            startTimer();
        });

        document.getElementById('submit').addEventListener('click', () => {
            saveCurrentAnswer();
            currentQuestionIndex++;
            if (currentQuestionIndex >= totalQuestions) endQuiz();
            else loadQuestion();
        });

        document.getElementById('prev').addEventListener('click', () => {
            saveCurrentAnswer();
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        });

        document.getElementById('viewMarked').addEventListener('click', () => {
            saveCurrentAnswer();
            const marked = userMarks.reduce((arr, v, i) => {
                if (v) arr.push(i);
                return arr;
            }, []);
            if (marked.length === 0) {
                alert('目前沒有標記的題目');
                return;
            }
            const pos = marked.indexOf(currentQuestionIndex);
            const next = pos === -1 ? 0 : (pos + 1) % marked.length;
            currentQuestionIndex = marked[next];
            loadQuestion();
        });

        document.getElementById('finish').addEventListener('click', () => {
            if (confirm('確定要交卷了嗎？')) endQuiz();
        });

        document.getElementById('clearStats').addEventListener('click', () => {
            localStorage.removeItem('quiz_stats');
            alert('已清除出題紀錄');
            location.reload();
        });

    </script>
</body>

</html>

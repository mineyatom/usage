<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TQC æ¸¬é©—ç³»çµ±</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f2f5;
      color: #2c3e50;
      transition: background-color 0.3s ease;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #4a90e2;
      margin-bottom: 20px;
    }

    .card {
      background: #ffffff;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .mode-select label {
      display: block;
      margin-bottom: 10px;
    }

    .question-image {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
      margin: 10px 0;
    }

    #questionPage {
      display: none;
    }

    #options label {
      display: block;
      background: #f8f9fa;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      flex: 1 1 30%;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      background-color: #4a90e2;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #357ab7;
    }

    #progressBar {
      width: 100%;
      height: 15px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin: 20px 0;
    }

    #progressBarFill {
      height: 100%;
      width: 0%;
      background-color: #28a745;
      transition: width 0.3s ease;
    }

    @media screen and (max-width: 600px) {
      .button-group {
        flex-direction: column;
      }

      button {
        flex: 1 1 100%;
      }

      .question-image {
        max-height: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>TQC å­¸ç§‘æ¸¬é©—</h1>

    <div id="startPage" class="card">
      <div class="mode-select">
        <label><input type="radio" name="mode" id="instantMode" value="instant" /> ç·´ç¿’æ¨¡å¼ï¼ˆå³æ™‚å°ç­”æ¡ˆï¼‰</label>
        <label><input type="radio" name="mode" id="examMode" value="exam" /> è€ƒè©¦æ¨¡å¼ï¼ˆä¸å³æ™‚å°ç­”æ¡ˆï¼‰</label>
        <label for="quizSelect">é¸æ“‡é¡Œåº«:</label>
        <select id="quizSelect">
          <option value="quiz1">è»Ÿé«”é–‹ç™¼çŸ¥è­˜</option>
          <option value="quiz2">HTML</option>
        </select>
      </div>
      <button id="startTest">é–‹å§‹æ¸¬é©—</button>
    </div>

    <div id="questionPage" class="card">
      <div id="timer">å‰©é¤˜æ™‚é–“ï¼š40:00</div>
      <div id="score" style="display:none;">ä½ çš„å¾—åˆ†ï¼š0 / 100</div>
      <div id="questionNumber"></div>
      <div id="progressBar">
        <div id="progressBarFill"></div>
      </div>
      <div id="question"></div>
      <div id="options"></div>
      <div class="button-group">
        <button id="prev">ä¸Šä¸€é¡Œ</button>
        <button id="submit">ä¸‹ä¸€é¡Œ</button>
        <button id="finish">äº¤å·</button>
      </div>
    </div>

    <div id="result" class="card"></div>
    <div id="answers" class="card" style="display:none;">
      <h3>ç­”é¡Œç´€éŒ„</h3>
      <ul id="answerList"></ul>
    </div>
  </div>

  <script>
    let quizData = [];
    let currentQuestionIndex = 0;
    let score = 0;
    const totalQuestions = 50;
    const passingScore = 35;
    let userAnswers = [];
    let checkedQuestions = Array(totalQuestions).fill(false);
    let timeLeft = 2400;
    let timerInterval;
    let isInstantMode = false;

    const timerEl = document.getElementById("timer");
    const scoreEl = document.getElementById("score");
    const progressBarFill = document.getElementById("progressBarFill");
    const answerListEl = document.getElementById("answerList");

    const quizFiles = {
      quiz1: "questions.json",
      quiz2: "questions2.json"
    };

    function startTimer() {
      timerInterval = setInterval(() => {
        if (timeLeft <= 0) return endQuiz();
        let min = Math.floor(timeLeft / 60);
        let sec = (timeLeft % 60).toString().padStart(2, '0');
        timerEl.innerText = `å‰©é¤˜æ™‚é–“ï¼š${min}:${sec}`;
        timeLeft--;
      }, 1000);
    }

    function loadQuiz() {
      const selectedQuiz = document.getElementById("quizSelect").value;
      fetch(quizFiles[selectedQuiz])
        .then(res => res.json())
        .then(data => {
          quizData = data.sort(() => 0.5 - Math.random()).slice(0, totalQuestions);
          loadQuestion();
        })
        .catch(err => {
          alert("é¡Œåº«è¼‰å…¥éŒ¯èª¤ï¼Œè«‹ç¢ºèª JSON æª”æ¡ˆå­˜åœ¨ä¸¦æ­£ç¢ºã€‚");
          console.error(err);
        });
    }

    function loadQuestion() {
      if (currentQuestionIndex >= quizData.length) return endQuiz();
      const q = quizData[currentQuestionIndex];
      document.getElementById("questionNumber").innerText = `ç¬¬ ${currentQuestionIndex + 1} / ${totalQuestions} é¡Œ`;

      const questionEl = document.getElementById("question");
      const optionsEl = document.getElementById("options");
      questionEl.innerHTML = "";
      optionsEl.innerHTML = "";

      const images = q.question.match(/<img src='(.*?)'/);
      if (images) {
        const img = document.createElement("img");
        img.src = images[1];
        img.alt = "question image";
        img.classList.add("question-image");
        questionEl.appendChild(img);
      }

      const questionText = document.createElement("div");
      questionText.innerHTML = q.question.replace(/<img.*?>/g, '');
      questionEl.appendChild(questionText);

      q.options.forEach((opt, i) => {
        const label = document.createElement("label");
        const input = document.createElement("input");
        input.type = q.answer.length > 1 ? "checkbox" : "radio";
        input.name = "answer";
        input.value = i + 1;
        if (userAnswers[currentQuestionIndex]?.includes(i + 1)) input.checked = true;
        input.addEventListener("change", updateScore);
        label.appendChild(input);
        label.append(` ${opt}`);
        optionsEl.appendChild(label);
      });

      document.getElementById("prev").disabled = currentQuestionIndex === 0;
      updateProgressBar();
    }

    function updateScore() {
      const selected = Array.from(document.querySelectorAll("input[name='answer']:checked"))
        .map(opt => parseInt(opt.value));
      userAnswers[currentQuestionIndex] = selected;

      const correct = quizData[currentQuestionIndex].answer;
      const isCorrect = JSON.stringify(selected.sort()) === JSON.stringify(correct.sort());

      if (isInstantMode) {
        if (isCorrect && !checkedQuestions[currentQuestionIndex]) {
          score += 2;
          checkedQuestions[currentQuestionIndex] = true;
        }
        if (!isCorrect && checkedQuestions[currentQuestionIndex]) {
          score -= 2;
          checkedQuestions[currentQuestionIndex] = false;
        }
        scoreEl.innerText = `ä½ çš„å¾—åˆ†ï¼š${score} / ${totalQuestions * 2}`;
        scoreEl.style.display = "block";
      }
    }

    function updateProgressBar() {
      const percent = ((currentQuestionIndex + 1) / totalQuestions) * 100;
      progressBarFill.style.width = `${percent}%`;

      // é€²åº¦æ¢é¡è‰²æ¼¸è®Šï¼ˆç¶ è‰² -> æ©™è‰² -> ç´…è‰²ï¼‰
      if (percent < 33) {
        progressBarFill.style.backgroundColor = "#28a745"; // ç¶ è‰²
      } else if (percent < 66) {
        progressBarFill.style.backgroundColor = "#ffc107"; // æ©™è‰²
      } else {
        progressBarFill.style.backgroundColor = "#dc3545"; // ç´…è‰²
      }
    }

    function endQuiz() {
      clearInterval(timerInterval);

      if (!isInstantMode) {
        score = 0;
        quizData.forEach((q, i) => {
          const userAns = userAnswers[i] || [];
          const correct = q.answer;
          const isCorrect = JSON.stringify(userAns.sort()) === JSON.stringify(correct.sort());
          if (isCorrect) score += 2;
        });
        scoreEl.innerText = `ä½ çš„å¾—åˆ†ï¼š${score} / ${totalQuestions * 2}`;
        scoreEl.style.display = "block";
      }

      const passed = score >= passingScore * 2;
      const resultEl = document.getElementById("result");
      resultEl.innerText = passed ? "ğŸ‰ æ­å–œä½ é€šéæ¸¬é©—ï¼" : "ğŸ˜¢ å¾ˆå¯æƒœï¼Œæœªé”åˆ°é€šéåˆ†æ•¸ã€‚";
      resultEl.style.color = passed ? "green" : "red";
      resultEl.style.fontSize = "24px";

      const restartBtn = document.createElement("button");
      restartBtn.textContent = "é‡æ–°æ¸¬é©—";
      restartBtn.style.backgroundColor = "#007bff";
      restartBtn.style.color = "white";
      restartBtn.onclick = () => location.reload();
      resultEl.appendChild(document.createElement("br"));
      resultEl.appendChild(restartBtn);

      displayAnswers();
    }

    function displayAnswers() {
      answerListEl.innerHTML = "";
      quizData.forEach((q, i) => {
        const userAns = userAnswers[i] || [];
        const correct = q.answer;
        const isCorrect = JSON.stringify(userAns.sort()) === JSON.stringify(correct.sort());

        const listItem = document.createElement("li");
        listItem.innerHTML = `
          <strong>ç¬¬ ${i + 1} é¡Œ:</strong>
          <br>å•é¡Œï¼š${q.question}
          <br>æ­£ç¢ºç­”æ¡ˆï¼š${correct.map(c => q.options[c - 1]).join(", ")}
          <br>ä½ çš„ç­”æ¡ˆï¼š${userAns.length > 0 ? userAns.map(ans => q.options[ans - 1]).join(", ") : "ç„¡é¸æ“‡"}
          <br>æ˜¯å¦æ­£ç¢ºï¼š${isCorrect ? "âœ… æ­£ç¢º" : "âŒ éŒ¯èª¤"}
        `;
        answerListEl.appendChild(listItem);
      });

      document.getElementById("answers").style.display = "block";
    }

    document.getElementById("submit").addEventListener("click", () => {
      currentQuestionIndex++;
      if (currentQuestionIndex >= totalQuestions) {
        endQuiz();
      } else {
        loadQuestion();
      }
    });

    document.getElementById("prev").addEventListener("click", () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        loadQuestion();
      }
    });

    document.getElementById("finish").addEventListener("click", endQuiz);

    document.getElementById("startTest").addEventListener("click", () => {
      isInstantMode = document.getElementById("instantMode").checked;

      document.getElementById("startPage").style.display = "none";
      document.getElementById("questionPage").style.display = "block";

      // ä¿®æ”¹èƒŒæ™¯é¡è‰²
      if (isInstantMode) {
        document.body.style.backgroundColor = "#ffe6ec"; // ç²‰ç´…è‰²
      } else {
        document.body.style.backgroundColor = "#e6ecf2"; // æ·¡è—è‰²
      }

      loadQuiz();
      startTimer();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TQC 測驗系統</title>
  <style>
    /* 色彩變數 */
    :root {
      --primary: #4A90E2;
      --success: #2ECC71;
      --info:    #3498DB;
      --warning: #F1C40F;
      --danger:  #E74C3C;
      --light:   #F0F2F5;
      --dark:    #2C3E50;
      --card-bg: #FFFFFF;
      --option-bg: #F8F9FA;
      --option-border: #CCC;
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background-color: var(--light); color: var(--dark); line-height: 1.6; }
    .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }
    h1, h2 { text-align: center; color: var(--primary); margin-bottom: 20px; }
    .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .form-group, .button-group { margin-bottom: 15px; }
    .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
    button { padding: 10px 18px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: background 0.2s, transform 0.1s; color: #fff; }
    button:hover { transform: translateY(-2px); }
    button:active { transform: scale(0.97); }
    .btn-primary { background: var(--primary); }
    .btn-success { background: var(--success); }
    .btn-info { background: var(--info); }
    .btn-warning { background: var(--warning); color: #000; }
    .btn-danger { background: var(--danger); }

    /* 進度條 */
    #progressBar { height: 14px; background: #e0e0e0; border-radius: 7px; overflow: hidden; margin: 20px 0; }
    #progressBarFill { height: 100%; width: 0; background: var(--success); transition: width 0.3s; }

    /* 專業選項樣式 */
    #options label { display: grid; grid-template-columns: 24px 1fr; align-items: center; padding: 12px 16px; margin-bottom: 12px; border-radius: 8px; border: 1px solid var(--option-border); background: var(--option-bg); transition: background 0.2s, border-color 0.2s; }
    #options label:hover { background: rgba(74, 144, 226, 0.1); border-color: var(--primary); }
    #options input { margin: 0; width: 20px; height: 20px; }

    /* 表單、表格 */
    select, input[type=text], input[type=number] { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; text-align: center; border-bottom: 1px solid #ddd; }
    th { background: var(--primary); color: #fff; }
    tr:nth-child(even) { background: #f9f9f9; }
  </style>
</head>
<body>
  <div class="container">
    <h1>TQC 學科測驗</h1>
    <!-- 開始卡片 -->
    <div id="startPage" class="card">
      <h2>選擇模式與題庫</h2>
      <div class="form-group">
        <label>模式：</label>
        <div class="button-group">
          <button id="instantModeBtn" class="btn-info">練習模式</button>
          <button id="examModeBtn" class="btn-primary">考試模式</button>
        </div>
      </div>
      <div class="form-group">
        <label for="quizSelect">題庫：</label>
        <select id="quizSelect">
          <option value="quiz1">軟體開發知識 2022 版</option>
          <option value="quiz2">軟體開發知識 2025 版</option>
          <option value="quiz3">HTML 基礎</option>
        </select>
      </div>
      <div class="button-group">
        <button id="startTest" class="btn-success">開始測驗</button>
        <button id="viewScores" class="btn-info">查看成績</button>
        <button id="clearAllScores" class="btn-danger">清除成績</button>
      </div>
    </div>
    <!-- 測驗卡片 -->
    <div id="questionPage" class="card" style="display:none;">
      <div id="timer">剩餘時間：40:00</div>
      <div id="questionNumber"></div>
      <div id="markContainer" class="form-group">
        <label><input type="checkbox" id="markQuestion" /> 標記此題</label>
      </div>
      <div id="question"></div>
      <div id="options"></div>
      <div id="progressBar"><div id="progressBarFill"></div></div>
      <div class="button-group">
        <button id="prev" class="btn-warning">上一題</button>
        <button id="next" class="btn-warning">下一題</button>
        <button id="viewMarked" class="btn-info">查看標記</button>
        <button id="finish" class="btn-primary">交卷</button>
      </div>
    </div>
    <!-- 查看成績卡片 -->
    <div id="view-score-card" class="card" style="display:none;">
      <h2>成績記錄</h2>
      <div class="form-group">
        <label for="subjectSelectModal">選擇題庫：</label>
        <select id="subjectSelectModal"></select>
      </div>
      <table id="storedScoreTable">
        <thead><tr><th>序號</th><th>分數</th><th>時間</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="button-group">
        <button id="closeViewScores" class="btn-warning">關閉</button>
        <button id="clearStoredScores" class="btn-danger">清除紀錄</button>
      </div>
    </div>
  </div>
  <script>
    // 題庫映射
    const quizFiles={quiz1:'questions.json',quiz2:'questions2.json',quiz3:'TQCHTML.json'};
    let quizData=[],currentQuestionIndex=0,score=0;
    const totalQuestions=50;
    let checkedQuestions=Array(totalQuestions).fill(false),userMarks=Array(totalQuestions).fill(false);
    let timeLeft=2400,timerInterval,isInstantMode=false;
    // DOM
    const timerEl=document.getElementById('timer'),qNumEl=document.getElementById('questionNumber'),
          qEl=document.getElementById('question'),oEl=document.getElementById('options'),
          progressFill=document.getElementById('progressBarFill'),markCheckbox=document.getElementById('markQuestion');
    // 模式
    document.getElementById('instantModeBtn').addEventListener('click',()=>{isInstantMode=true;toggleModeButtons();});
    document.getElementById('examModeBtn').addEventListener('click',()=>{isInstantMode=false;toggleModeButtons();});
    function toggleModeButtons(){
      document.getElementById('instantModeBtn').className=isInstantMode?'btn-success':'btn-info';
      document.getElementById('examModeBtn').className=isInstantMode?'btn-info':'btn-success';
    }
    // 計時
    function startTimer(){timerInterval=setInterval(()=>{if(timeLeft<=0)return endQuiz();const m=Math.floor(timeLeft/60),s=String(timeLeft%60).padStart(2,'0');timerEl.textContent=`剩餘時間：${m}:${s}`;timeLeft--;},1000);}    
    // 載題
    function fetchQuizData(file, callback) {
      fetch(file)
        .then(response => response.json())
        .then(callback)
        .catch(error => {
          console.error('載入錯誤', error);
          alert('資料載入錯誤！請稍後再試。');
        });
    }
    document.getElementById('startTest').addEventListener('click',()=>{document.getElementById('startPage').style.display='none';document.getElementById('questionPage').style.display='block';document.body.style.backgroundColor=isInstantMode?'#ffe6ec':'#e6ecf2';fetchQuizData(quizFiles[document.getElementById('quizSelect').value],data=>{data.sort(()=>0.5-Math.random());quizData=data.slice(0,totalQuestions);loadQuestion();startTimer();});});
    function loadQuestion(){const q=quizData[currentQuestionIndex];qNumEl.textContent=`第 ${currentQuestionIndex+1} / ${totalQuestions} 題`;markCheckbox.checked=userMarks[currentQuestionIndex];qEl.textContent=q.question.replace(/<[^>]+>/g,'');oEl.innerHTML='';q.options.forEach((opt,i)=>{const lbl=document.createElement('label');const inp=document.createElement('input');inp.type=q.answer.length>1?'checkbox':'radio';inp.name='ans';inp.value=i+1;inp.addEventListener('change',updateScore);lbl.appendChild(inp);lbl.append(` ${opt}`);oEl.appendChild(lbl);});document.getElementById('next').style.display=currentQuestionIndex===totalQuestions-1?'none':'inline-block';progressFill.style.width=`${(currentQuestionIndex+1)/totalQuestions*100}%`;}    
    markCheckbox.addEventListener('change',()=>{userMarks[currentQuestionIndex]=markCheckbox.checked;});
    document.getElementById('viewMarked').addEventListener('click',()=>{const marked=userMarks.reduce((arr,v,i)=>v?arr.concat(i):arr,[]);if(!marked.length)return alert('無標記題目');const idx=marked.indexOf(currentQuestionIndex);currentQuestionIndex=marked[(idx+1)%marked.length];loadQuestion();});
    function updateScore(){if(!isInstantMode) return;const sel=Array.from(document.querySelectorAll('input[name=ans]:checked')).map(e=>+e.value),cor=quizData[currentQuestionIndex].answer;const right=JSON.stringify(sel.sort())===JSON.stringify(cor.sort());if(right&&!checkedQuestions[currentQuestionIndex]){score+=2;checkedQuestions[currentQuestionIndex]=true;}}
    document.getElementById('prev').addEventListener('click',()=>{if(currentQuestionIndex>0){currentQuestionIndex--;loadQuestion();}});
    document.getElementById('next').addEventListener('click',()=>{currentQuestionIndex++;if(currentQuestionIndex<totalQuestions)loadQuestion();});
    document.getElementById('finish').addEventListener('click',()=>{if(confirm('確定要交卷嗎？'))endQuiz();});
    // 結束及記錄
    const RECORD_KEY='score_records';function loadRecords(){return JSON.parse(localStorage.getItem(RECORD_KEY)||'{}');}function saveRecords(r){localStorage.setItem(RECORD_KEY,JSON.stringify(r));}
    function endQuiz(){clearInterval(timerInterval);if(!isInstantMode){score=0;quizData.forEach(q=>{const sel=Array.from(document.querySelectorAll('input[name=ans]:checked')).map(e=>+e.value);if(JSON.stringify(sel.sort())===JSON.stringify(q.answer.sort()))score+=2;});qEl.textContent=`測驗結束！總分：${score}`;const subj=document.getElementById('quizSelect').selectedOptions[0].text;const recs=loadRecords();if(!recs[subj])recs[subj]=[];recs[subj].push({score:score,time:new Date().toLocaleString()});if(recs[subj].length>10)recs[subj].shift();saveRecords(recs);}else{qEl.textContent='練習模式結束，不儲存成績';}}    
    // 查看清除成績
    document.getElementById('viewScores').addEventListener('click',()=>{const recs=loadRecords(),sel=document.getElementById('subjectSelectModal');sel.innerHTML='';Object.keys(recs).forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;sel.appendChild(o);});if(!sel.options.length)return alert('無紀錄');document.getElementById('view-score-card').style.display='block';renderStoredScores();});
    document.getElementById('clearAllScores').addEventListener('click',()=>{if(confirm('清除所有紀錄?')){localStorage.removeItem(RECORD_KEY);document.getElementById('view-score-card').style.display='none';}});
    document.getElementById('clearStoredScores').addEventListener('click',()=>{const subj=document.getElementById('subjectSelectModal').value;if(!confirm(`清除「${subj}」所有紀錄？`))return;const recs=loadRecords();delete recs[subj];saveRecords(recs);document.getElementById('view-score-card').style.display='none';});
    document.getElementById('subjectSelectModal').addEventListener('change',renderStoredScores);
    function renderStoredScores(){const subj=document.getElementById('subjectSelectModal').value;const recs=loadRecords()[subj]||[],tb=document.querySelector('#storedScoreTable tbody');tb.innerHTML='';recs.slice().reverse().forEach((r,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${i+1}</td><td>${r.score}</td><td>${r.time}</td>`;tb.appendChild(tr);});}
    // init
    toggleModeButtons();
  </script>
</body>
</html>

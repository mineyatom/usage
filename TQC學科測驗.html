<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TQC æ¸¬é©—ç³»çµ±</title>
    <style>
        /* å…¨å±€æ¨£å¼ */
        body {
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #2c3e50;
            overflow-y: auto;
        }

        .container {
            max-width: 900px;
            margin: auto;
            padding: 20px;
            min-height: 100vh;
        }

        h1 {
            text-align: center;
            color: #4a90e2;
        }

        .card {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* æ¨¡å¼é¸æ“‡å’Œé–‹å§‹æŒ‰éˆ• */
        .mode-select label {
            display: block;
            margin-bottom: 10px;
        }

        /* é¡Œç›®é¸é … */
        #options label {
            display: block;
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
            cursor: pointer;
            /* è‡ªå‹•æ›è¡Œ */
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        button,
        .button-group button {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background-color: #4a90e2;
            color: #fff;
            cursor: pointer;
            transition: all .2s;
        }

        button:hover,
        .button-group button:hover {
            background-color: #357ab7;
            transform: translateY(-2px);
        }

        button:active {
            transform: scale(0.97);
        }

        /* è‡ªè¨‚æŒ‰éˆ•é¡è‰² */
        .btn-green {
            background-color: #28a745;
        }

        .btn-green:hover {
            background-color: #218838;
        }

        .btn-blue {
            background-color: #003366;
        }

        .btn-blue:hover {
            background-color: #002244;
        }

        .btn-red {
            background-color: #dc3545;
        }

        .btn-red:hover {
            background-color: #c82333;
        }

        button.btn-yellow {
            background-color: #ffc107;
            color: #000;
        }

        button.btn-yellow:hover {
            background-color: #e0a800;
        }

        /* é€²åº¦æ¢ */
        #progressBar {
            height: 15px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        #progressBarFill {
            height: 100%;
            width: 0;
            background: #28a745;
            transition: width .3s;
        }

        @media (max-width:600px) {
            .button-group {
                flex-direction: column;
            }
        }

    </style>
</head>

<body>
    <div class="container">
        <h1>TQC å­¸ç§‘æ¸¬é©—</h1>

        <!-- é–‹å§‹é é¢ -->
        <div id="startPage" class="card">
            <div class="mode-select">
                <label><input type="radio" name="mode" id="instantMode" value="instant" /> ç·´ç¿’æ¨¡å¼ï¼ˆå³æ™‚å°ç­”æ¡ˆï¼‰</label>
                <label><input type="radio" name="mode" id="examMode" value="exam" /> è€ƒè©¦æ¨¡å¼ï¼ˆä¸å³æ™‚å°ç­”æ¡ˆï¼‰</label>
            </div>
            <label>é¸æ“‡é¡Œåº«:
                <select id="quizSelect">
                    <option value="quiz1">è»Ÿé«”é–‹ç™¼çŸ¥è­˜2022ç‰ˆ</option>
                    <option value="quiz2">è»Ÿé«”é–‹ç™¼çŸ¥è­˜2025ç‰ˆ</option>
                    <option value="quiz3">HTML</option>
                </select>
            </label>
            <button id="startTest" class="btn-green">é–‹å§‹æ¸¬é©—</button>
            <button id="showStats" class="btn-blue">æŸ¥çœ‹å‡ºé¡Œçµ±è¨ˆ</button>
            <button id="clearStats" class="btn-red">æ¸…é™¤å‡ºé¡Œç´€éŒ„</button>
        </div>

        <!-- æ¸¬é©—é é¢ -->
        <div id="questionPage" class="card" style="display:none;">
            <div id="timer">å‰©é¤˜æ™‚é–“ï¼š40:00</div>
            <div id="score" style="display:none;"></div>
            <div id="questionNumber"></div>

            <!-- æ¨™è¨˜é¡Œç›® åŠŸèƒ½ -->
            <label><input type="checkbox" id="markCurrent" /> æ¨™è¨˜æ­¤é¡Œ</label>

            <!-- è½‰é èˆ‡æ¨™è¨˜æŒ‰éˆ•ç¾¤çµ„ -->
            <div class="button-group">
                <button id="prev">ä¸Šä¸€é¡Œ</button>
                <button id="submit">ä¸‹ä¸€é¡Œ</button>
                <button id="viewMarked" class="btn-yellow">æŸ¥çœ‹æ¨™è¨˜é¡Œç›®</button>
                <button id="finish">äº¤å·</button>
            </div>

            <!-- é€²åº¦æ¢é¡¯ç¤º -->
            <div id="progressBar">
                <div id="progressBarFill"></div>
            </div>

            <!-- é¡Œç›®å…§å®¹å€ -->
            <div id="question"></div>
            <!-- é¸é …åˆ—è¡¨å€ -->
            <div id="options"></div>
        </div>

        <!-- è©³ç´°è§£ç­”èˆ‡çµ±è¨ˆçµæœé¡¯ç¤º -->
        <div id="answers" class="card"></div>
        <div id="statsTableContainer" class="card"></div>
    </div>

    <script>
        // é¡Œåº«æª”æ¡ˆå°æ‡‰
        const quizFiles = {
            quiz1: "questions.json",
            quiz2: "questions2.json",
            quiz3: "TQCHTML.json"
        };

        // å…¨åŸŸç‹€æ…‹
        let quizData = [],
            currentQuestionIndex = 0,
            score = 0;
        const totalQuestions = 50,
            passingScore = 35;
        let userAnswers = [],
            checkedQuestions = Array(totalQuestions).fill(false),
            userMarks = Array(totalQuestions).fill(false),
            timeLeft = 2400,
            timerInterval, isInstantMode = false;

        // DOM åƒè€ƒ
        const timerEl = document.getElementById('timer'),
            scoreEl = document.getElementById('score'),
            progressBarFill = document.getElementById('progressBarFill');
        const markCheckbox = document.getElementById('markCurrent'),
            viewMarkedBtn = document.getElementById('viewMarked');

        /** é–‹å§‹å€’æ•¸è¨ˆæ™‚ */
        function startTimer() {
            timerInterval = setInterval(() => {
                if (timeLeft <= 0) return endQuiz();
                const m = Math.floor(timeLeft / 60);
                const s = String(timeLeft % 60).padStart(2, '0');
                timerEl.innerText = `å‰©é¤˜æ™‚é–“ï¼š${m}:${s}`;
                timeLeft--;
            }, 1000);
        }

        /** è¼‰å…¥é¡Œåº« JSON */
        function fetchQuizData(url, callback) {
            fetch(url)
                .then(res => res.json())
                .then(callback)
                .catch(() => alert('è³‡æ–™è¼‰å…¥éŒ¯èª¤ï¼'));
        }

        /** è¨˜éŒ„å‡ºé¡Œèˆ‡ç­”å°æ¬¡æ•¸ */
        function recordQuestionStats(id, isCorrect) {
            const key = 'quiz_stats';
            const stats = JSON.parse(localStorage.getItem(key)) || {};
            if (!stats[id]) stats[id] = {
                count: 0,
                correct: 0
            };
            stats[id].count++;
            if (isCorrect) stats[id].correct++;
            localStorage.setItem(key, JSON.stringify(stats));
        }

        /** å„²å­˜ç›®å‰ç­”æ¡ˆèˆ‡æ¨™è¨˜ */
        function saveCurrentAnswer() {
            userAnswers[currentQuestionIndex] = Array.from(
                document.querySelectorAll("input[name='answer']:checked")
            ).map(e => +e.value);
            userMarks[currentQuestionIndex] = markCheckbox.checked;
        }

        /** éš¨æ©Ÿå–é¡Œä¸¦å•Ÿå‹• */
        function loadQuiz() {
            const sel = document.getElementById('quizSelect').value;
            fetchQuizData(quizFiles[sel], data => {
                // æ‰“äº‚ã€æ¬Šé‡ã€é¸é¡Œæµç¨‹
                data.sort(() => 0.5 - Math.random());
                const stats = JSON.parse(localStorage.getItem('quiz_stats')) || {};
                const pool = [];
                data.forEach(q => {
                    const id = q.id || q.question;
                    const cnt = stats[id]?.count || 0;
                    const weight = Math.ceil(10 / (cnt + 1));
                    for (let j = 0; j < weight; j++) pool.push(q);
                });
                const selected = [];
                const used = new Set();
                while (selected.length < totalQuestions && pool.length) {
                    const idx = Math.floor(Math.random() * pool.length);
                    const q = pool.splice(idx, 1)[0];
                    const id = q.id || q.question;
                    if (!used.has(id)) {
                        selected.push(q);
                        used.add(id);
                    }
                }
                while (selected.length < totalQuestions) {
                    selected.push(data[Math.floor(Math.random() * data.length)]);
                }
                quizData = selected;
                currentQuestionIndex = 0;
                loadQuestion();
            });
        }

        /** é¡¯ç¤ºå–®é¡Œ */
        function loadQuestion() {
            const qObj = quizData[currentQuestionIndex];
            const qId = qObj.id || qObj.question;
            recordQuestionStats(qId, false);

            document.getElementById('questionNumber').innerText = `ç¬¬ ${currentQuestionIndex + 1} / ${totalQuestions} é¡Œ`;
            markCheckbox.checked = userMarks[currentQuestionIndex];
            document.getElementById('prev').disabled = currentQuestionIndex === 0;

            // ä¸‹ä¸€é¡ŒæŒ‰éˆ•é¡¯ç¤ºæ§åˆ¶
            const nextBtn = document.getElementById('submit');
            if (currentQuestionIndex === totalQuestions - 1) nextBtn.style.display = 'none';
            else nextBtn.style.display = 'inline-block';

            const qEl = document.getElementById('question');
            const oEl = document.getElementById('options');
            qEl.innerHTML = '';
            oEl.innerHTML = '';

            let raw = qObj.question.replace(/<img.*?>/g, '')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>');
            const txt = document.createElement('div');
            txt.textContent = raw;
            qEl.appendChild(txt);
            const imgMatch = qObj.question.match(/<img src=['"](.*?)['"]/);
            if (imgMatch) {
                const img = document.createElement('img');
                img.src = imgMatch[1];
                img.className = 'question-image';
                qEl.appendChild(img);
            }

            qObj.options.forEach((opt, idx) => {
                const label = document.createElement('label');
                const inp = document.createElement('input');
                inp.type = qObj.answer.length > 1 ? 'checkbox' : 'radio';
                inp.name = 'answer';
                inp.value = idx + 1;
                inp.checked = (userAnswers[currentQuestionIndex] || []).includes(idx + 1);
                inp.addEventListener('change', updateScore);
                label.appendChild(inp);
                label.append(` ${opt}`);
                oEl.appendChild(label);
            });

            progressBarFill.style.width = `${(currentQuestionIndex + 1) / totalQuestions * 100}%`;
        }

        /** æ›´æ–°åˆ†æ•¸ï¼ˆå³æ™‚æ¨¡å¼ï¼‰ */
        function updateScore() {
            const sel = Array.from(document.querySelectorAll("input[name='answer']:checked")).map(e => +e.value);
            userAnswers[currentQuestionIndex] = sel;
            const correctAns = quizData[currentQuestionIndex].answer;
            const isCor = JSON.stringify(sel.sort()) === JSON.stringify(correctAns.sort());
            if (isInstantMode) {
                if (isCor && !checkedQuestions[currentQuestionIndex]) {
                    score += 2;
                    checkedQuestions[currentQuestionIndex] = true;
                }
                if (!isCor && checkedQuestions[currentQuestionIndex]) {
                    score -= 2;
                    checkedQuestions[currentQuestionIndex] = false;
                }
                scoreEl.innerText = `ä½ çš„å¾—åˆ†ï¼š${score} / ${totalQuestions * 2}`;
                scoreEl.style.display = 'block';
            }
            recordQuestionStats(quizData[currentQuestionIndex].id || quizData[currentQuestionIndex].question, isCor);
        }

        /** çµæŸæ¸¬é©—ä¸¦é¡¯ç¤ºçµæœ */
        function endQuiz() {
            clearInterval(timerInterval);
            if (!isInstantMode) {
                score = 0;
                quizData.forEach((qObj, idx) => {
                    const ua = userAnswers[idx] || [];
                    const isCor = JSON.stringify(ua.sort()) === JSON.stringify(qObj.answer.sort());
                    if (isCor) score += 2;
                    recordQuestionStats(qObj.id || qObj.question, isCor);
                });
            }
            const passed = score >= passingScore * 2;
            scoreEl.innerHTML = `
                <div style="font-size:20px; margin-bottom:10px;">ä½ çš„å¾—åˆ†ï¼š${score} / ${totalQuestions * 2}</div>
                <div style="font-size:24px; color:${passed ? 'green' : 'red'};">${passed ? 'ğŸ‰ æ­å–œé€šéï¼' : 'ğŸ˜¢ æœªé”æ¨™'}</div>
            `;
            const btn = document.createElement('button');
            btn.textContent = 'é‡æ–°æ¸¬é©—';
            btn.className = 'btn-blue';
            btn.onclick = () => location.reload();
            scoreEl.appendChild(btn);
            scoreEl.style.display = 'block';
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // äº‹ä»¶ç¶å®š
        document.getElementById('startTest').addEventListener('click', () => {
            const modeSel = document.querySelector("input[name='mode']:checked");
            if (!modeSel) return alert('è«‹é¸æ“‡æ¸¬é©—æ¨¡å¼');
            isInstantMode = document.getElementById('instantMode').checked;
            document.getElementById('startPage').style.display = 'none';
            document.getElementById('questionPage').style.display = 'block';
            document.body.style.backgroundColor = isInstantMode ? '#ffe6ec' : '#e6ecf2';
            loadQuiz();
            startTimer();
        });

        document.getElementById('submit').addEventListener('click', () => {
            saveCurrentAnswer();
            currentQuestionIndex++;
            if (currentQuestionIndex >= totalQuestions) endQuiz();
            else loadQuestion();
        });

        document.getElementById('prev').addEventListener('click', () => {
            saveCurrentAnswer();
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        });

        document.getElementById('viewMarked').addEventListener('click', () => {
            saveCurrentAnswer();
            const marked = userMarks.reduce((arr, v, i) => {
                if (v) arr.push(i);
                return arr;
            }, []);
            if (marked.length === 0) {
                alert('ç›®å‰æ²’æœ‰æ¨™è¨˜çš„é¡Œç›®');
                return;
            }
            const pos = marked.indexOf(currentQuestionIndex);
            const next = pos === -1 ? 0 : (pos + 1) % marked.length;
            currentQuestionIndex = marked[next];
            loadQuestion();
        });

        document.getElementById('finish').addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦äº¤å·äº†å—ï¼Ÿ')) endQuiz();
        });

        document.getElementById('clearStats').addEventListener('click', () => {
            localStorage.removeItem('quiz_stats');
            alert('å·²æ¸…é™¤å‡ºé¡Œç´€éŒ„');
            location.reload();
        });

    </script>
</body>

</html>

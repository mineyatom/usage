<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TQC 測驗系統</title>
    <style>
        /* 全局樣式 */
        body {
            overflow-y: auto;
            /* 滾動 */
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #2c3e50;
            margin: 0;
            padding: 0;
        }

        .container {
            /* 容器置中，適應寬度 */
            min-height: 100vh;
            max-width: 900px;
            margin: auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #4a90e2;
        }

        .card {
            /* 卡片樣式 */
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .mode-select label {
            display: block;
            margin-bottom: 10px;
        }

        .question-image {
            /* 題目圖片限制 */
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            margin: 10px 0;
        }

        #options label {
            /* 選項樣式 */
            display: block;
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button,
        .button-group button {
            /* 按鈕基礎樣式 */
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background: #4a90e2;
            color: white;
            cursor: pointer;
            transition: all .2s;
        }

        button:hover,
        .button-group button:hover {
            /* 懸停效果 */
            background: #357ab7;
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: scale(0.97);
        }

        #progressBar {
            /* 進度條外框 */
            height: 15px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        #progressBarFill {
            /* 進度條填充 */
            height: 100%;
            width: 0;
            background: #28a745;
            transition: width .3s;
        }

        .correct {
            background: #c8e6c9;
            border-color: #2ecc71;
        }

        .missed {
            background: #bbdefb;
            border-color: #2196f3;
        }

        .wrong {
            background: #ffcdd2;
            border-color: #e53935;
        }

        @media (max-width:600px) {
            .button-group {
                flex-direction: column;
            }

            .question-image {
                max-height: 200px;
            }
        }

        /* 顏色按鈕 */
        .btn {
            display: inline-block;
            font-size: 16px;
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            color: white;
            cursor: pointer;
            margin-top: 10px;
            transition: all .2s;
        }

        .btn-green {
            background: #28a745;
        }

        .btn-green:hover {
            background: #218838;
        }

        .btn-blue {
            background: #003366;
        }

        .btn-blue:hover {
            background: #002244;
        }

        .btn-red {
            background: #dc3545;
        }

        .btn-red:hover {
            background: #c82333;
        }

        /* 統計顏色 */
        .green {
            background: #c8e6c9;
        }

        .yellow {
            background: #fff9c4;
        }

        .red {
            background: #ffcdd2;
        }

    </style>
</head>

<body>
    <div class="container">
        <h1>TQC 學科測驗</h1>
        <!-- 開始頁面：模式 & 題庫 選擇 -->
        <div id="startPage" class="card">
            <div class="mode-select">
                <label><input type="radio" name="mode" id="instantMode" value="instant" /> 練習模式（即時對答案）</label>
                <label><input type="radio" name="mode" id="examMode" value="exam" /> 考試模式（不即時對答案）</label>
                <label>選擇題庫:
                    <select id="quizSelect">
                        <option value="quiz1">軟體開發知識2022版</option>
                        <option value="quiz2">軟體開發知識2025版</option>
                        <option value="quiz3">HTML</option>
                    </select>
                </label>
            </div>
            <button id="startTest" class="btn btn-green">開始測驗</button>
            <button id="showStats" class="btn btn-blue">查看出題統計</button>
            <select id="statsQuizSelect" style="display:none; margin-top:10px;">
                <option value="quiz1">軟體開發知識2022版</option>
                <option value="quiz2">軟體開發知識2025版</option>
                <option value="quiz3">HTML</option>
            </select>
            <button id="clearStats" class="btn btn-red">清除出題紀錄</button>
        </div>

        <!-- 測驗頁面：題目顯示與按鈕 -->
        <div id="questionPage" class="card" style="display:none;">
            <div id="timer">剩餘時間：40:00</div> <!-- 倒數計時 -->
            <div id="score" style="display:none;"></div> <!-- 即時模式顯示分數 -->
            <div id="questionNumber"></div> <!-- 題目序號 -->
            <div id="progressBar">
                <div id="progressBarFill"></div>
            </div> <!-- 進度條 -->
            <div id="question"></div> <!-- 題幹 -->
            <div id="options"></div> <!-- 選項 -->
            <div class="button-group">
                <button id="prev">上一題</button>
                <button id="submit">下一題</button>
                <button id="finish">交卷</button>
            </div>
        </div>

        <!-- 結果與統計 -->
        <div id="answers" class="card"></div>
        <div id="statsTableContainer" class="card"></div>
    </div>

    <script>
        // 題庫對應檔案
        const quizFiles = {
            quiz1: "questions.json",
            quiz2: "questions2.json",
            quiz3: "TQCHTML.json"
        };
        // 全域變數
        let quizData = [],
            currentQuestionIndex = 0,
            score = 0;
        const totalQuestions = 50,
            passingScore = 35;
        let userAnswers = [],
            checkedQuestions = Array(totalQuestions).fill(false);
        let timeLeft = 2400,
            timerInterval, isInstantMode = false;

        // DOM 參考
        const timerEl = document.getElementById('timer');
        const scoreEl = document.getElementById('score');
        const progressBarFill = document.getElementById('progressBarFill');

        /**
         * 開始倒數計時
         */
        function startTimer() {
            timerInterval = setInterval(() => {
                if (timeLeft <= 0) return endQuiz();
                const m = Math.floor(timeLeft / 60);
                const s = String(timeLeft % 60).padStart(2, '0');
                timerEl.innerText = `剩餘時間：${m}:${s}`;
                timeLeft--;
            }, 1000);
        }

        /**
         * 取得題庫 JSON
         */
        function fetchQuizData(url, callback) {
            fetch(url)
                .then(res => res.json())
                .then(callback)
                .catch(() => alert('資料載入錯誤！'));
        }

        /**
         * 更新出題統計 (count & correct)
         */
        function recordQuestionStats(id, isCorrect) {
            const key = 'quiz_stats';
            const stats = JSON.parse(localStorage.getItem(key)) || {};
            if (!stats[id]) stats[id] = {
                count: 0,
                correct: 0
            };
            stats[id].count++;
            if (isCorrect) stats[id].correct++;
            localStorage.setItem(key, JSON.stringify(stats));
        }

        /**
         * 載入並隨機選題
         */
        function loadQuiz() {
            const sel = document.getElementById('quizSelect').value;
            fetchQuizData(quizFiles[sel], data => {
                data.sort(() => 0.5 - Math.random());
                const stats = JSON.parse(localStorage.getItem('quiz_stats')) || {};
                const pool = [];
                data.forEach((q, i) => {
                    const key = q.id || q.question;
                    const cnt = stats[key]?.count || 0;
                    const times = Math.ceil((1 / (cnt + 1)) * 10);
                    for (let j = 0; j < times; j++) pool.push(q);
                });
                const selected = [];
                const used = new Set();
                // 從權重池取題，確保不重複
                while (selected.length < totalQuestions && pool.length) {
                    const idx = Math.floor(Math.random() * pool.length);
                    const q = pool.splice(idx, 1)[0];
                    const key = q.id || q.question;
                    if (!used.has(key)) {
                        selected.push(q);
                        used.add(key);
                    }
                }
                // 若不足則隨機補足
                while (selected.length < totalQuestions)
                    selected.push(data[Math.floor(Math.random() * data.length)]);
                quizData = selected;
                currentQuestionIndex = 0;
                loadQuestion();
            });
        }

        /**
         * 顯示單一題目
         */
        function loadQuestion() {
            // 每次出題都統計一次 count
            recordQuestionStats(quizData[currentQuestionIndex].id || quizData[currentQuestionIndex].question, false);
            const q = quizData[currentQuestionIndex];
            document.getElementById('questionNumber').innerText = `第 ${currentQuestionIndex + 1} / ${totalQuestions} 題`;
            const qEl = document.getElementById('question');
            const oEl = document.getElementById('options');
            qEl.innerHTML = '';
            oEl.innerHTML = '';
            // 題目若有圖片
            const m = q.question.match(/<img src='(.*?)'/);
            if (m) {
                const img = document.createElement('img');
                img.src = m[1];
                img.className = 'question-image';
                qEl.appendChild(img);
            }
            // 題幹文字
            const txt = document.createElement('div');
            txt.textContent = qQUESTION_CONTENT_REPLACE;
            qEl.appendChild(txt);
            // 選項
            q.options.forEach((opt, i) => {
                const label = document.createElement('label');
                const inp = document.createElement('input');
                inp.type = q.answer.length > 1 ? 'checkbox' : 'radio';
                inp.name = 'answer';
                inp.value = i + 1;
                inp.addEventListener('change', updateScore);
                label.appendChild(inp);
                label.append(` ${opt}`);
                oEl.appendChild(label);
            });
            document.getElementById('prev').disabled = currentQUESTION_INDEX_CONDITION;
            updateProgressBar();
        }

        /**
         * 更新分數 (即時模式)
         */
        function updateScore() {
            const sel = Array.from(document.querySelectorAll("input[name='answer']:checked")).map(e => +e.value);
            userAnswers[currentQuestionIndex] = sel;
            const correct = quizData[currentQUESTION_INDEX].answer;
            const isCor = JSON.stringify(sel.sort()) === JSON.stringify(correct.sort());
            if (isInstantMode) {
                if (isCor && !checkedQuestions[currentQuestionIndex]) {
                    score += 2;
                    checkedQuestions[currentQUESTION_INDEX] = true;
                }
                if (!isCor && checkedQuestions[currentQuestion_INDEX]) {
                    score -= 2;
                    checkedQuestions[currentQUESTION_INDEX] = false;
                }
                scoreEl.innerText = `你的得分：${score} / ${totalQuestions * 2}`;
                scoreEl.style.display = 'block';
            }
            recordQuestionStats(quizData[currentQUESTION_INDEX].id || quizData[currentQUESTION_INDEX].question, isCor);
        }

        /**
         * 更新進度條
         */
        function updateProgressBar() {
            progressBarFill.style.width = `${((currentQuestionIndex + 1) / totalQUESTIONS)*100}%`;
        }

        /**
         * 結束測驗並顯示結果
         */
        function endQuiz() {
            clearInterval(timerInterval);
            if (!isInstantMode) {
                score = 0;
                quizData.forEach((q, i) => {
                    const ua = userAnswers[i] || [];
                    const isCor = JSON.stringify(ua.sort()) === JSON.stringify(q.answer.sort());
                    if (isCor) score += 2;
                    recordQuestionStats(q.id || q.question, isCor);
                });
            }
            const passed = score >= passingScore * 2;
            scoreEl.innerHTML = `<div style="font-size:20px;margin-bottom:10px;">你的得分：${score} / ${totalQuestions*2}</div><div style="font-size:24px;color:${passed?'green':'red'};">${passed?'🎉 恭喜你通過測驗！':'😢 未達標準'}</div>`;
            const btn = document.createElement('button');
            btn.textContent = '重新測驗';
            btn.className = 'btn btn-blue';
            btn.onclick = () => location.reload();
            scoreEl.appendChild(document.createElement('br'));
            scoreEl.appendChild(btn);
            scoreEl.style.display = 'block';
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
            // 顯示詳細解答
            const ansEl = document.getElementById('answers');
            ansEl.innerHTML = '<h3>詳細解答</h3>';
            quizData.forEach((q, i) => {
                const d = document.createElement('div');
                d.innerHTML = `<strong>第 ${i+1} 題：</strong>`;
                const t = document.createElement('div');
                t.textContent = q.question.replace(/<img.*?>/g, '');
                d.appendChild(t);
                q.options.forEach((opt, j) => {
                    const num = j + 1;
                    const sel = (userAnswers[i] || []).includes(num);
                    const cor = q.answer.includes(num);
                    const l = document.createElement('div');
                    l.textContent = `【${num}】${opt}`;
                    l.className = cor ? (sel ? 'correct' : 'missed') : (sel ? 'wrong' : '');
                    d.appendChild(l);
                });
                const ua2 = (userAnswers[i] || []).sort().join(',') || '未作答';
                const ca2 = q.answer.sort().join(',');
                const exp = document.createElement('div');
                exp.innerHTML = `<strong>你的答案：</strong>${ua2} ｜ <strong>正確答案：</strong>${ca2}`;
                exp.style.marginTop = '10px';
                d.appendChild(exp);
                ansEl.appendChild(d);
            });
        }

        // 事件監聽器
        document.getElementById('startTest').addEventListener('click', () => {
            const m = document.querySelector("input[name='mode']:checked");
            if (!m) return alert('請選擇模式！');
            isInstantMode = document.getElementById('instantMode').checked;
            document.getElementById('startPage').style.display = 'none';
            document.getElementById('questionPage').style.display = 'block';
            document.body.style.backgroundColor = isInstantMode ? '#ffe6ec' : '#e6ecf2';
            loadQuiz();
            startTimer();
        });
        document.getElementById('submit').addEventListener('click', () => {
            currentQuestionIndex++;
            currentQuestionIndex >= totalQUESTIONS ? endQuiz() : loadQuestion();
        });
        document.getElementById('prev').addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--, loadQuestion()
            }
        });
        document.getElementById('finish').addEventListener('click', endQuiz);

        document.getElementById('showStats').addEventListener('click', () => {
            const sel = document.getElementById('statsQuizSelect');
            sel.style.display = 'inline-block';
            sel.value = document.getElementById('quizSelect').value;
            sel.dispatchEvent(new Event('change'));
            sel.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        });
        document.getElementById('clearStats').addEventListener('click', () => {
            localStorage.removeItem('quiz_stats');
            alert('已清除統計！');
            location.reload();
        });
        document.getElementById('statsQuizSelect').addEventListener('change', function() {
            fetchQuizData(quizFiles[this.value], data => {
                const stats = JSON.parse(localStorage.getItem('quiz_stats')) || {};
                const table = document.createElement('table');
                table.border = '1';
                table.style.width = '100%';
                table.innerHTML = '<tr><th>題號</th><th>題目</th><th>次數</th><th>正確率</th></tr>';
                data.forEach((q, i) => {
                    const key = q.id || q.question;
                    const c = stats[key]?.count || 0;
                    const co = stats[key]?.correct || 0;
                    const rate = c ? Math.round(co / c * 100) : 0;
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${i+1}</td><td>${q.question.replace(/<img.*?>/g,'').slice(0,30)}...</td><td>${c}</td><td class='${rate>=80?'green':rate>=60?'yellow':'red'}'>${rate}%</td>`;
                    table.appendChild(row);
                });
                const quizKeys = data.map(q => q.id || q.question);
                const appeared = quizKeys.filter(k => JSON.parse(localStorage.getItem('quiz_stats') || '{}')[k]?.count > 0).length;
                const container = document.getElementById('statsTableContainer');
                const summary = document.createElement('div');
                summary.style.marginBottom = '10px';
                summary.innerHTML = `<strong>已出題目數：</strong>${appeared} / ${quizKeys.length}`;
                container.innerHTML = '';
                container.appendChild(summary);
                container.appendChild(table);
            });
        });

    </script>
</body>

</html>

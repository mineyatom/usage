<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TQC æ¸¬é©—ç³»çµ±</title>
    <style>
        /* å…¨å±€æ¨£å¼ */
        body {
            overflow-y: auto;
            /* æ»¾å‹• */
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #2c3e50;
            margin: 0;
            padding: 0;
        }

        .container {
            /* å®¹å™¨ç½®ä¸­ï¼Œé©æ‡‰å¯¬åº¦ */
            min-height: 100vh;
            max-width: 900px;
            margin: auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #4a90e2;
        }

        .card {
            /* å¡ç‰‡æ¨£å¼ */
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .mode-select label {
            display: block;
            margin-bottom: 10px;
        }

        .question-image {
            /* é¡Œç›®åœ–ç‰‡é™åˆ¶ */
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            margin: 10px 0;
        }

        #options label {
            /* é¸é …æ¨£å¼ */
            display: block;
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button,
        .button-group button {
            /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background: #4a90e2;
            color: white;
            cursor: pointer;
            transition: all .2s;
        }

        button:hover,
        .button-group button:hover {
            /* æ‡¸åœæ•ˆæœ */
            background: #357ab7;
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: scale(0.97);
        }

        #progressBar {
            /* é€²åº¦æ¢å¤–æ¡† */
            height: 15px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        #progressBarFill {
            /* é€²åº¦æ¢å¡«å…… */
            height: 100%;
            width: 0;
            background: #28a745;
            transition: width .3s;
        }

        .correct {
            background: #c8e6c9;
            border-color: #2ecc71;
        }

        .missed {
            background: #bbdefb;
            border-color: #2196f3;
        }

        .wrong {
            background: #ffcdd2;
            border-color: #e53935;
        }

        @media (max-width:600px) {
            .button-group {
                flex-direction: column;
            }

            .question-image {
                max-height: 200px;
            }
        }

        /* é¡è‰²æŒ‰éˆ• */
        .btn {
            display: inline-block;
            font-size: 16px;
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            color: white;
            cursor: pointer;
            margin-top: 10px;
            transition: all .2s;
        }

        .btn-green {
            background: #28a745;
        }

        .btn-green:hover {
            background: #218838;
        }

        .btn-blue {
            background: #003366;
        }

        .btn-blue:hover {
            background: #002244;
        }

        .btn-red {
            background: #dc3545;
        }

        .btn-red:hover {
            background: #c82333;
        }

        /* çµ±è¨ˆé¡è‰² */
        .green {
            background: #c8e6c9;
        }

        .yellow {
            background: #fff9c4;
        }

        .red {
            background: #ffcdd2;
        }

    </style>
</head>

<body>
    <div class="container">
        <h1>TQC å­¸ç§‘æ¸¬é©—</h1>
        <!-- é–‹å§‹é é¢ï¼šæ¨¡å¼ & é¡Œåº« é¸æ“‡ -->
        <div id="startPage" class="card">
            <div class="mode-select">
                <label><input type="radio" name="mode" id="instantMode" value="instant" /> ç·´ç¿’æ¨¡å¼ï¼ˆå³æ™‚å°ç­”æ¡ˆï¼‰</label>
                <label><input type="radio" name="mode" id="examMode" value="exam" /> è€ƒè©¦æ¨¡å¼ï¼ˆä¸å³æ™‚å°ç­”æ¡ˆï¼‰</label>
                <label>é¸æ“‡é¡Œåº«:
                    <select id="quizSelect">
                        <option value="quiz1">è»Ÿé«”é–‹ç™¼çŸ¥è­˜2022ç‰ˆ</option>
                        <option value="quiz2">è»Ÿé«”é–‹ç™¼çŸ¥è­˜2025ç‰ˆ</option>
                        <option value="quiz3">HTML</option>
                    </select>
                </label>
            </div>
            <button id="startTest" class="btn btn-green">é–‹å§‹æ¸¬é©—</button>
            <button id="showStats" class="btn btn-blue">æŸ¥çœ‹å‡ºé¡Œçµ±è¨ˆ</button>
            <select id="statsQuizSelect" style="display:none; margin-top:10px;">
                <option value="quiz1">è»Ÿé«”é–‹ç™¼çŸ¥è­˜2022ç‰ˆ</option>
                <option value="quiz2">è»Ÿé«”é–‹ç™¼çŸ¥è­˜2025ç‰ˆ</option>
                <option value="quiz3">HTML</option>
            </select>
            <button id="clearStats" class="btn btn-red">æ¸…é™¤å‡ºé¡Œç´€éŒ„</button>
        </div>

        <!-- æ¸¬é©—é é¢ï¼šé¡Œç›®é¡¯ç¤ºèˆ‡æŒ‰éˆ• -->
        <div id="questionPage" class="card" style="display:none;">
            <div id="timer">å‰©é¤˜æ™‚é–“ï¼š40:00</div> <!-- å€’æ•¸è¨ˆæ™‚ -->
            <div id="score" style="display:none;"></div> <!-- å³æ™‚æ¨¡å¼é¡¯ç¤ºåˆ†æ•¸ -->
            <div id="questionNumber"></div> <!-- é¡Œç›®åºè™Ÿ -->
            <div id="progressBar">
                <div id="progressBarFill"></div>
            </div> <!-- é€²åº¦æ¢ -->
            <div id="question"></div> <!-- é¡Œå¹¹ -->
            <div id="options"></div> <!-- é¸é … -->
            <div class="button-group">
                <button id="prev">ä¸Šä¸€é¡Œ</button>
                <button id="submit">ä¸‹ä¸€é¡Œ</button>
                <button id="finish">äº¤å·</button>
            </div>
        </div>

        <!-- çµæœèˆ‡çµ±è¨ˆ -->
        <div id="answers" class="card"></div>
        <div id="statsTableContainer" class="card"></div>
    </div>

    <script>
        // é¡Œåº«å°æ‡‰æª”æ¡ˆ
        const quizFiles = {
            quiz1: "questions.json",
            quiz2: "questions2.json",
            quiz3: "TQCHTML.json"
        };
        // å…¨åŸŸè®Šæ•¸
        let quizData = [],
            currentQuestionIndex = 0,
            score = 0;
        const totalQuestions = 50,
            passingScore = 35;
        let userAnswers = [],
            checkedQuestions = Array(totalQuestions).fill(false);
        let timeLeft = 2400,
            timerInterval, isInstantMode = false;

        // DOM åƒè€ƒ
        const timerEl = document.getElementById('timer');
        const scoreEl = document.getElementById('score');
        const progressBarFill = document.getElementById('progressBarFill');

        /**
         * é–‹å§‹å€’æ•¸è¨ˆæ™‚
         */
        function startTimer() {
            timerInterval = setInterval(() => {
                if (timeLeft <= 0) return endQuiz();
                const m = Math.floor(timeLeft / 60);
                const s = String(timeLeft % 60).padStart(2, '0');
                timerEl.innerText = `å‰©é¤˜æ™‚é–“ï¼š${m}:${s}`;
                timeLeft--;
            }, 1000);
        }

        /**
         * å–å¾—é¡Œåº« JSON
         */
        function fetchQuizData(url, callback) {
            fetch(url)
                .then(res => res.json())
                .then(callback)
                .catch(() => alert('è³‡æ–™è¼‰å…¥éŒ¯èª¤ï¼'));
        }

        /**
         * æ›´æ–°å‡ºé¡Œçµ±è¨ˆ (count & correct)
         */
        function recordQuestionStats(id, isCorrect) {
            const key = 'quiz_stats';
            const stats = JSON.parse(localStorage.getItem(key)) || {};
            if (!stats[id]) stats[id] = {
                count: 0,
                correct: 0
            };
            stats[id].count++;
            if (isCorrect) stats[id].correct++;
            localStorage.setItem(key, JSON.stringify(stats));
        }

        /**
         * è¼‰å…¥ä¸¦éš¨æ©Ÿé¸é¡Œ
         */
        function loadQuiz() {
            const sel = document.getElementById('quizSelect').value;
            fetchQuizData(quizFiles[sel], data => {
                data.sort(() => 0.5 - Math.random());
                const stats = JSON.parse(localStorage.getItem('quiz_stats')) || {};
                const pool = [];
                data.forEach((q, i) => {
                    const key = q.id || q.question;
                    const cnt = stats[key]?.count || 0;
                    const times = Math.ceil((1 / (cnt + 1)) * 10);
                    for (let j = 0; j < times; j++) pool.push(q);
                });
                const selected = [];
                const used = new Set();
                // å¾æ¬Šé‡æ± å–é¡Œï¼Œç¢ºä¿ä¸é‡è¤‡
                while (selected.length < totalQuestions && pool.length) {
                    const idx = Math.floor(Math.random() * pool.length);
                    const q = pool.splice(idx, 1)[0];
                    const key = q.id || q.question;
                    if (!used.has(key)) {
                        selected.push(q);
                        used.add(key);
                    }
                }
                // è‹¥ä¸è¶³å‰‡éš¨æ©Ÿè£œè¶³
                while (selected.length < totalQuestions)
                    selected.push(data[Math.floor(Math.random() * data.length)]);
                quizData = selected;
                currentQuestionIndex = 0;
                loadQuestion();
            });
        }

        /**
         * é¡¯ç¤ºå–®ä¸€é¡Œç›®
         */
        function loadQuestion() {
            // æ¯æ¬¡å‡ºé¡Œéƒ½çµ±è¨ˆä¸€æ¬¡ count
            recordQuestionStats(quizData[currentQuestionIndex].id || quizData[currentQuestionIndex].question, false);
            const q = quizData[currentQuestionIndex];
            document.getElementById('questionNumber').innerText = `ç¬¬ ${currentQuestionIndex + 1} / ${totalQuestions} é¡Œ`;
            const qEl = document.getElementById('question');
            const oEl = document.getElementById('options');
            qEl.innerHTML = '';
            oEl.innerHTML = '';
            // é¡Œç›®è‹¥æœ‰åœ–ç‰‡
            const m = q.question.match(/<img src='(.*?)'/);
            if (m) {
                const img = document.createElement('img');
                img.src = m[1];
                img.className = 'question-image';
                qEl.appendChild(img);
            }
            // é¡Œå¹¹æ–‡å­—
            const txt = document.createElement('div');
            txt.textContent = qQUESTION_CONTENT_REPLACE;
            qEl.appendChild(txt);
            // é¸é …
            q.options.forEach((opt, i) => {
                const label = document.createElement('label');
                const inp = document.createElement('input');
                inp.type = q.answer.length > 1 ? 'checkbox' : 'radio';
                inp.name = 'answer';
                inp.value = i + 1;
                inp.addEventListener('change', updateScore);
                label.appendChild(inp);
                label.append(` ${opt}`);
                oEl.appendChild(label);
            });
            document.getElementById('prev').disabled = currentQUESTION_INDEX_CONDITION;
            updateProgressBar();
        }

        /**
         * æ›´æ–°åˆ†æ•¸ (å³æ™‚æ¨¡å¼)
         */
        function updateScore() {
            const sel = Array.from(document.querySelectorAll("input[name='answer']:checked")).map(e => +e.value);
            userAnswers[currentQuestionIndex] = sel;
            const correct = quizData[currentQUESTION_INDEX].answer;
            const isCor = JSON.stringify(sel.sort()) === JSON.stringify(correct.sort());
            if (isInstantMode) {
                if (isCor && !checkedQuestions[currentQuestionIndex]) {
                    score += 2;
                    checkedQuestions[currentQUESTION_INDEX] = true;
                }
                if (!isCor && checkedQuestions[currentQuestion_INDEX]) {
                    score -= 2;
                    checkedQuestions[currentQUESTION_INDEX] = false;
                }
                scoreEl.innerText = `ä½ çš„å¾—åˆ†ï¼š${score} / ${totalQuestions * 2}`;
                scoreEl.style.display = 'block';
            }
            recordQuestionStats(quizData[currentQUESTION_INDEX].id || quizData[currentQUESTION_INDEX].question, isCor);
        }

        /**
         * æ›´æ–°é€²åº¦æ¢
         */
        function updateProgressBar() {
            progressBarFill.style.width = `${((currentQuestionIndex + 1) / totalQUESTIONS)*100}%`;
        }

        /**
         * çµæŸæ¸¬é©—ä¸¦é¡¯ç¤ºçµæœ
         */
        function endQuiz() {
            clearInterval(timerInterval);
            if (!isInstantMode) {
                score = 0;
                quizData.forEach((q, i) => {
                    const ua = userAnswers[i] || [];
                    const isCor = JSON.stringify(ua.sort()) === JSON.stringify(q.answer.sort());
                    if (isCor) score += 2;
                    recordQuestionStats(q.id || q.question, isCor);
                });
            }
            const passed = score >= passingScore * 2;
            scoreEl.innerHTML = `<div style="font-size:20px;margin-bottom:10px;">ä½ çš„å¾—åˆ†ï¼š${score} / ${totalQuestions*2}</div><div style="font-size:24px;color:${passed?'green':'red'};">${passed?'ğŸ‰ æ­å–œä½ é€šéæ¸¬é©—ï¼':'ğŸ˜¢ æœªé”æ¨™æº–'}</div>`;
            const btn = document.createElement('button');
            btn.textContent = 'é‡æ–°æ¸¬é©—';
            btn.className = 'btn btn-blue';
            btn.onclick = () => location.reload();
            scoreEl.appendChild(document.createElement('br'));
            scoreEl.appendChild(btn);
            scoreEl.style.display = 'block';
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
            // é¡¯ç¤ºè©³ç´°è§£ç­”
            const ansEl = document.getElementById('answers');
            ansEl.innerHTML = '<h3>è©³ç´°è§£ç­”</h3>';
            quizData.forEach((q, i) => {
                const d = document.createElement('div');
                d.innerHTML = `<strong>ç¬¬ ${i+1} é¡Œï¼š</strong>`;
                const t = document.createElement('div');
                t.textContent = q.question.replace(/<img.*?>/g, '');
                d.appendChild(t);
                q.options.forEach((opt, j) => {
                    const num = j + 1;
                    const sel = (userAnswers[i] || []).includes(num);
                    const cor = q.answer.includes(num);
                    const l = document.createElement('div');
                    l.textContent = `ã€${num}ã€‘${opt}`;
                    l.className = cor ? (sel ? 'correct' : 'missed') : (sel ? 'wrong' : '');
                    d.appendChild(l);
                });
                const ua2 = (userAnswers[i] || []).sort().join(',') || 'æœªä½œç­”';
                const ca2 = q.answer.sort().join(',');
                const exp = document.createElement('div');
                exp.innerHTML = `<strong>ä½ çš„ç­”æ¡ˆï¼š</strong>${ua2} ï½œ <strong>æ­£ç¢ºç­”æ¡ˆï¼š</strong>${ca2}`;
                exp.style.marginTop = '10px';
                d.appendChild(exp);
                ansEl.appendChild(d);
            });
        }

        // äº‹ä»¶ç›£è½å™¨
        document.getElementById('startTest').addEventListener('click', () => {
            const m = document.querySelector("input[name='mode']:checked");
            if (!m) return alert('è«‹é¸æ“‡æ¨¡å¼ï¼');
            isInstantMode = document.getElementById('instantMode').checked;
            document.getElementById('startPage').style.display = 'none';
            document.getElementById('questionPage').style.display = 'block';
            document.body.style.backgroundColor = isInstantMode ? '#ffe6ec' : '#e6ecf2';
            loadQuiz();
            startTimer();
        });
        document.getElementById('submit').addEventListener('click', () => {
            currentQuestionIndex++;
            currentQuestionIndex >= totalQUESTIONS ? endQuiz() : loadQuestion();
        });
        document.getElementById('prev').addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--, loadQuestion()
            }
        });
        document.getElementById('finish').addEventListener('click', endQuiz);

        document.getElementById('showStats').addEventListener('click', () => {
            const sel = document.getElementById('statsQuizSelect');
            sel.style.display = 'inline-block';
            sel.value = document.getElementById('quizSelect').value;
            sel.dispatchEvent(new Event('change'));
            sel.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        });
        document.getElementById('clearStats').addEventListener('click', () => {
            localStorage.removeItem('quiz_stats');
            alert('å·²æ¸…é™¤çµ±è¨ˆï¼');
            location.reload();
        });
        document.getElementById('statsQuizSelect').addEventListener('change', function() {
            fetchQuizData(quizFiles[this.value], data => {
                const stats = JSON.parse(localStorage.getItem('quiz_stats')) || {};
                const table = document.createElement('table');
                table.border = '1';
                table.style.width = '100%';
                table.innerHTML = '<tr><th>é¡Œè™Ÿ</th><th>é¡Œç›®</th><th>æ¬¡æ•¸</th><th>æ­£ç¢ºç‡</th></tr>';
                data.forEach((q, i) => {
                    const key = q.id || q.question;
                    const c = stats[key]?.count || 0;
                    const co = stats[key]?.correct || 0;
                    const rate = c ? Math.round(co / c * 100) : 0;
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${i+1}</td><td>${q.question.replace(/<img.*?>/g,'').slice(0,30)}...</td><td>${c}</td><td class='${rate>=80?'green':rate>=60?'yellow':'red'}'>${rate}%</td>`;
                    table.appendChild(row);
                });
                const quizKeys = data.map(q => q.id || q.question);
                const appeared = quizKeys.filter(k => JSON.parse(localStorage.getItem('quiz_stats') || '{}')[k]?.count > 0).length;
                const container = document.getElementById('statsTableContainer');
                const summary = document.createElement('div');
                summary.style.marginBottom = '10px';
                summary.innerHTML = `<strong>å·²å‡ºé¡Œç›®æ•¸ï¼š</strong>${appeared} / ${quizKeys.length}`;
                container.innerHTML = '';
                container.appendChild(summary);
                container.appendChild(table);
            });
        });

    </script>
</body>

</html>
